commit 201b0a48ff13daa12440cedfe1eaf3d123b05c51
Author: Chao Peng <chao.p.peng@linux.intel.com>
Date:   Thu Mar 3 18:54:03 2016 -0500

    kvm: cache cpuid info
    
    Signed-off-by: Chao Peng <chao.p.peng@linux.intel.com>

diff --git a/target-i386/kvm.c b/target-i386/kvm.c
index 799fdfa..bb717ac 100644
--- a/target-i386/kvm.c
+++ b/target-i386/kvm.c
@@ -103,6 +103,8 @@ static int has_xsave;
 static int has_xcrs;
 static int has_pit_state2;
 
+static struct kvm_cpuid2 *cpuid_cache;
+
 int kvm_has_pit_state2(void)
 {
     return has_pit_state2;
@@ -196,9 +198,14 @@ static struct kvm_cpuid2 *get_supported_cpuid(KVMState *s)
 {
     struct kvm_cpuid2 *cpuid;
     int max = 1;
+
+    if (cpuid_cache != NULL) {
+        return cpuid_cache;
+    }
     while ((cpuid = try_get_cpuid(s, max)) == NULL) {
         max *= 2;
     }
+    cpuid_cache = cpuid;
     return cpuid;
 }
 
@@ -316,8 +323,6 @@ uint32_t kvm_arch_get_supported_cpuid(KVMState *s, uint32_t function,
         ret |= cpuid_1_edx & CPUID_EXT2_AMD_ALIASES;
     }
 
-    g_free(cpuid);
-
     /* fallback for older kernels */
     if ((function == KVM_CPUID_FEATURES) && !found) {
         ret = get_para_features(s);
@@ -1083,6 +1088,12 @@ static void register_smram_listener(Notifier *n, void *unused)
                                  &smram_address_space, 1);
 }
 
+static Notifier kvm_exit_notifier;
+static void kvm_arch_destroy(Notifier *n, void *unused)
+{
+    g_free(cpuid_cache);
+}
+
 int kvm_arch_init(MachineState *ms, KVMState *s)
 {
     uint64_t identity_base = 0xfffbc000;
@@ -1158,6 +1169,9 @@ int kvm_arch_init(MachineState *ms, KVMState *s)
         smram_machine_done.notify = register_smram_listener;
         qemu_add_machine_init_done_notifier(&smram_machine_done);
     }
+
+    kvm_exit_notifier.notify = kvm_arch_destroy;
+    qemu_add_exit_notifier(&kvm_exit_notifier);
     return 0;
 }
 
